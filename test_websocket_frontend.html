<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { 
            border: 1px solid #ccc; 
            height: 400px; 
            overflow-y: auto; 
            padding: 10px;
            margin: 10px 0;
            background: #f5f5f5;
        }
        .message { 
            margin: 5px 0; 
            padding: 5px;
            background: white;
            border-radius: 4px;
        }
        .text-chunk { color: #0066cc; }
        .session { color: #009900; }
        .error { color: #cc0000; }
        .connected { color: #009900; font-weight: bold; }
        .completed { color: #666666; font-style: italic; }
        button { padding: 10px 20px; margin: 5px; }
        #status { font-weight: bold; margin: 10px 0; }
        #assembled { 
            background: #e8f4e8; 
            padding: 10px; 
            margin: 10px 0;
            border-radius: 4px;
            min-height: 50px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Frontend Test</h1>
    <div id="status">Status: Disconnected</div>
    
    <button onclick="connect()">Connect</button>
    <button onclick="sendMessage()">Send Test Message</button>
    <button onclick="disconnect()">Disconnect</button>
    
    <div id="assembled">
        <strong>Assembled Response:</strong>
        <div id="assembledText"></div>
    </div>
    
    <div id="messages"></div>

    <script>
        let ws = null;
        let messageCount = 0;
        let assembledText = '';
        const sessionId = generateUUID();

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function updateStatus(text, color) {
            const status = document.getElementById('status');
            status.textContent = `Status: ${text}`;
            status.style.color = color || 'black';
        }

        function addMessage(text, className) {
            const messages = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message ${className || ''}`;
            message.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('Already connected', 'error');
                return;
            }

            const url = 'ws://127.0.0.1:8058/ws';
            addMessage(`Connecting to ${url}...`, 'info');
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                updateStatus('Connected', 'green');
                addMessage('WebSocket connected successfully', 'connected');
                messageCount = 0;
                assembledText = '';
                document.getElementById('assembledText').textContent = '';
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    messageCount++;
                    
                    if (data.type === 'connected') {
                        addMessage(`Confirmation: ${JSON.stringify(data.data)}`, 'connected');
                    } else if (data.type === 'session') {
                        addMessage(`Session: ${data.data.session_id}`, 'session');
                    } else if (data.type === 'text' && data.data && data.data.content) {
                        const content = data.data.content;
                        addMessage(`Text chunk: "${content}"`, 'text-chunk');
                        assembledText += content;
                        document.getElementById('assembledText').textContent = assembledText;
                    } else if (data.type === 'completed') {
                        addMessage('Stream completed', 'completed');
                    } else if (data.type === 'error') {
                        addMessage(`Error: ${JSON.stringify(data.data)}`, 'error');
                    } else {
                        addMessage(`Unknown message type: ${JSON.stringify(data)}`, 'info');
                    }
                } catch (err) {
                    addMessage(`Error parsing message: ${err.message}`, 'error');
                }
            };
            
            ws.onerror = (error) => {
                updateStatus('Error', 'red');
                addMessage(`WebSocket error: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                updateStatus('Disconnected', 'gray');
                addMessage('WebSocket disconnected', 'info');
                ws = null;
            };
        }

        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('Not connected', 'error');
                return;
            }
            
            const message = {
                type: 'chat',
                session_id: sessionId,
                user_id: 'test_user',
                data: {
                    message: 'Ciao, come funziona la riabilitazione della spalla?',
                    search_type: 'hybrid'
                }
            };
            
            ws.send(JSON.stringify(message));
            addMessage(`Sent: ${message.data.message}`, 'info');
            assembledText = '';
            document.getElementById('assembledText').textContent = '';
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
    </script>
</body>
</html>